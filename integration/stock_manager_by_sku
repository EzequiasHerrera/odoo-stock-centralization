import sys
import os
import xmlrpc.client
from dotenv import load_dotenv

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from productos import buscar_producto_por_sku
from tiendanube.productos_service import actualizar_stock_segun_sku;

load_dotenv()

url = os.getenv("ODOO_URL")
db = os.getenv("ODOO_DB")
username = os.getenv("ODOO_USER")
password = os.getenv("ODOO_PASS")

class SafeTransport(xmlrpc.client.SafeTransport):
    def __init__(self, use_datetime=False):
        super().__init__(use_datetime=use_datetime)

transport = SafeTransport()
common = xmlrpc.client.ServerProxy(f"{url}/xmlrpc/2/common", transport=transport)
uid = common.authenticate(db, username, password, {})

if not uid:
    print("❌ Error al conectar.")
    exit()

models = xmlrpc.client.ServerProxy(f"{url}/xmlrpc/2/object", transport=transport)

SKU = "Test-ProB-Blan-L"

# Esta funcion vamos a cambiarla para que reciba el SKU en cuestion, lo busque en Odoo, tome el stock y lo actualice en TN
def update_stock_on_tn_based_on_odoo(sku):
    odoo_product = buscar_producto_por_sku(models, db, uid, password, sku)
    print(f"Stock virtual de Odoo para {odoo_product['name']}: {odoo_product['stock_virtual']}")
    
    if odoo_product:
        actualizar_stock_segun_sku(sku, odoo_product["stock_virtual"]);
    else:
        print("❌ Producto no encontrado.")
        
update_stock_on_tn_based_on_odoo(SKU);